#!/bin/bash

set -euo pipefail

bash cloud-init/generate.sh

cd "$(dirname "${0}")"

echo "########################################################################################################"
echo "########################################################################################################"
echo "###                                                                                                  ###"
echo "### Generate Raspberry PI OS                                                                         ###"
echo "###                                                                                                  ###"
echo "########################################################################################################"
echo "########################################################################################################"

# もしPackerプラグインを使うようであれば、コメントアウトを外す
# echo "===================================================================================================="
# echo "= Initialize packer plugin."
# echo "===================================================================================================="
# docker compose -f packer-init.yml up

while read -r server; do
    echo "===================================================================================================="
    echo "= start build gateway image a ${server}."
    echo "===================================================================================================="
    export MACHINE_NAME="${server}"
    docker compose -f image-build.yml up
done < ./gateway-list

while read -r server; do
    echo "===================================================================================================="
    echo "= start build cluster image a ${server}."
    echo "===================================================================================================="
    export MACHINE_NAME="${server}"
    docker compose -f image-build.yml up
done < ./cluster-list
